<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Workflow for using DRIVES database tables with drivesR</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Workflow for using DRIVES database tables
with drivesR</h1>



<p>This vignette documents a workflow for accessing and harmonizing
tables from the Diverse Rotations Improve Valuable Ecosystem Services
(DRIVES) database at <a href="https://data.drives-network.org">data.drives-network.org</a>. The
database contains yield and weather data from 21 long-term agricultural
field experiments with a crop rotation component. You can find out more
about the DRIVE project and request access at our website, <a href="https://www.drives-network.org/">drives-network.org/</a>. Metadata
and a full data inventory can be found at the DRIVES database repository
on Ag Data Commons: <a href="https://hdl.handle.net/10779/USDA.ADC.28654694" class="uri">https://hdl.handle.net/10779/USDA.ADC.28654694</a>.</p>
<p>This package has two main purposes for users interested in analyzing
DRIVES data. First, it provides easy-to-use functions to download data
tables from the Directus API. Second, it provides harmonization
functions to combine and reshape tables for analysis.</p>
<p>As of May 2025, access to DRIVES database tables requires an API key.
Project members and collaborators can request an API key from the DRIVES
data manager, which will provide full read access. Other users must
complete our <a href="https://www.drives-network.org/data-request">data
use survey</a> and agree to our data use terms to receive an API key.
The latter will be assigned a role called “approved public access.” This
role has read access to a subset of the data excluding sites and site
years embargoed from public access.</p>
<div id="installation" class="section level1">
<h1>Installation</h1>
<p>To install the drivesR package, use the install_github function from
the devtools package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;DRIVES-project/drivesR&quot;</span>, <span class="at">ref =</span> <span class="st">&quot;main&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(drivesR)</span></code></pre></div>
</div>
<div id="accessing-the-drives-database" class="section level1">
<h1>Accessing the DRIVES database</h1>
<div id="requesting-access" class="section level2">
<h2>Requesting access</h2>
<p>The DRIVES database is hosted at <a href="https://data.drives-network.org/">data.drives-network.org/</a>. We
ask that anyone interesting in using DRIVES data complete the <a href="https://www.drives-network.org/data-request">data request
form</a>. Direct collaborators and project members can request access
directly from the DRIVES data manager. Either way, you will receive an
email with a username, password, and API key.</p>
<p>You can use the username and password to log in to the <a href="https://data.drives-network.org/admin/login">Directus Data Studio
Application</a>, where you can change your password and view tables
through the graphical interface. While you can download tables from this
application, we recommend doing so through the drivesR package. The API
key is all you need to access the data through the drivesR package.</p>
</div>
<div id="directus-api-key" class="section level2">
<h2>Directus API key:</h2>
<p>After you complete the request process, you will receive a Directus
API key set to your user permissions. This is a string of random letters
and numbers. For use with this package, the Directus API key must be
formatted, “Bearer APIKEY”.</p>
<p>It’s best practice never to hard-code an API key into a script. We
recommend making a setup script that is sourced by other scripts (be
sure to add this to your .gitignore if you’re using github).
Alternatively, you can use this script to read the API key from a
non-indexed location.</p>
<p>The code below generates an empty script file in your working
directory that opens in R studio.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">edit_file</span>(<span class="st">&quot;directus_creds.R&quot;</span>)</span></code></pre></div>
<p>Once you have an empty script file, you can add something like this,
replacing MYAPI key with the API key you received.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>directus_token <span class="ot">=</span> <span class="st">&quot;Bearer MYAPIKEY&quot;</span></span></code></pre></div>
</div>
<div id="setup-steps" class="section level2">
<h2>Setup steps</h2>
<p>If you format your setup script as described above, you should
include these lines of code at the beginning of every any script that
downloads DRIVES tables:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">library</span>(drivesR)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;directus_creds.R&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">set_default_token</span>(directus_token)</span></code></pre></div>
<p>The last line sets the global option for the Directus token that is
used by functions in the drivesR package. You can view this option with
getOption(“drivesR.default.directus.token”).</p>
<p>DRIVES collaborators and project members with full read-access will
need to add one extra line:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">set_public_access</span>(<span class="at">public =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>By default, the drivesR package reads from data tables with approved
public access privileges, which excludes certain sites and site-years.
This function allows approved users to access the full database.</p>
</div>
<div id="downloading-drives-tables." class="section level2">
<h2>Downloading DRIVES tables.</h2>
<p>The drivesR package has several options for accessing DRIVES database
tables</p>
<ol style="list-style-type: decimal">
<li><em>Download individual tables.</em> The <em>get_db_table</em>
function uses table names as inputs.</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>crop_info <span class="ot">&lt;-</span> <span class="fu">get_db_table</span>(<span class="st">&quot;crop_info&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">str</span>(crop_info)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt; &#39;data.frame&#39;:    91 obs. of  11 variables:</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt;  $ crop_id            : chr  &quot;alfalfa&quot; &quot;alfalfa mix&quot; &quot;alfalfa plus&quot; &quot;annual grass-forb mix&quot; ...</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt;  $ parent_crop_id     : chr  &quot;alfalfa plus&quot; &quot;alfalfa plus&quot; NA &quot;annual mix&quot; ...</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt;  $ species_name       : chr  &quot;Medicago sativa L.&quot; NA NA NA ...</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt;  $ is_a_mix           : logi  FALSE TRUE TRUE TRUE TRUE TRUE ...</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt;  $ family             : chr  &quot;Fabaceae&quot; NA NA NA ...</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt;  $ perenniality       : chr  &quot;perennial&quot; &quot;perennial&quot; &quot;perennial&quot; &quot;annual&quot; ...</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt;  $ photosynthetic_mode: chr  &quot;C3&quot; NA NA NA ...</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt;  $ seasonality        : chr  &quot;warm season&quot; NA NA NA ...</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt;  $ base_temp_c        : int  5 NA NA NA NA NA NA NA NA NA ...</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt;  $ max_temp_c         : num  43.3 NA NA NA NA NA NA NA NA NA ...</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">#&gt;  $ gdd_references     : chr  &quot;Parsons et al 2006&quot; NA NA NA ...</span></span></code></pre></div>
<p>You can see the names of tables available for public access by
running this code after the package is loaded (this excludes dictionary
tables that are available without an API key).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">options</span>(<span class="st">&quot;drivesR.default.tablevec&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt; $drivesR.default.tablevec</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;crop_info&quot;                    &quot;crop_variety_info&quot;            &quot;crop_yields&quot;                 </span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;experimental_unit_info&quot;       &quot;experimental_unit_treatments&quot; &quot;harvest_dates&quot;               </span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;planting_info&quot;                &quot;rotation_id_info&quot;             &quot;rotation_phases&quot;             </span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#&gt; [10] &quot;site_info&quot;                    &quot;site_treatment_level_info&quot;    &quot;site_treatment_type_info&quot;    </span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; [13] &quot;treatment_id_components&quot;      &quot;treatment_id_info&quot;            &quot;weather_daily&quot;               </span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt; [16] &quot;weather_station_info&quot;</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li><em>Download multiple tables at once.</em> The
<em>import_db_tables</em> function accesses multiple tables at once.
This can be used in several ways depending on your workflow and system
limitations.</li>
</ol>
<p>The argument “tablevec” determines which database tables are
downloaded. By default, the function downloads all tables in
<em>getOption(“drivesR.default.tablevec”)</em>. If set to NULL, the
function will download all tables available to your user role. You can
also provide a vector of table names.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">import_db_tables</span>(<span class="at">tablevec =</span>  <span class="fu">c</span>(<span class="st">&quot;crop_yields&quot;</span>,<span class="st">&quot;site_info&quot;</span>,<span class="st">&quot;experimental_unit_treatments&quot;</span>))</span></code></pre></div>
<p>For the remaining examples, we’ll assume the default “tablevec”
option.</p>
<p>The argument “fetch_option” controls whether tables are imported as a
list to the global R environment (“download.only”), saved to a specified
directory (“save.only”), or both (“download.only”). It also has the
option to read tables from a local directory after they have been
downloaded (“upload”). The latter option allows you to rerun the same
code without having to repeat the time-consuming step of downloading the
tables. For example, you could run the following code to download tables
into a list in your global R environment and saved as an RData file on
your local directory:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">import_db_tables</span>(<span class="at">fetch_option =</span> <span class="st">&quot;download.save&quot;</span>,</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>                       <span class="co">#fetch_option = &quot;upload&quot;,</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>                       <span class="at">savedir =</span> <span class="st">&quot;data&quot;</span>,</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                       <span class="at">savename =</span> <span class="st">&quot;sampledblist&quot;</span>)</span></code></pre></div>
<p>Then, you can move the comment and rerun the same code to load the
tables from the local directory:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">import_db_tables</span>(<span class="co">#fetch_option = &quot;download.save&quot;,</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>                       <span class="at">fetch_option =</span> <span class="st">&quot;upload&quot;</span>,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>                       <span class="at">savedir =</span> <span class="st">&quot;data&quot;</span>,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>                       <span class="at">savename =</span> <span class="st">&quot;sampledblist&quot;</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt; Imported list db with tables:</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">#&gt; crop_info</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt; crop_variety_info</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="co">#&gt; crop_yields</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co">#&gt; experimental_unit_info</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="co">#&gt; experimental_unit_treatments</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co">#&gt; harvest_dates</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="co">#&gt; planting_info</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="co">#&gt; rotation_id_info</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co">#&gt; rotation_phases</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co">#&gt; site_info</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co">#&gt; site_treatment_level_info</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="co">#&gt; site_treatment_type_info</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="co">#&gt; treatment_id_components</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co">#&gt; treatment_id_info</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="co">#&gt; weather_daily</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="co">#&gt; weather_station_info</span></span></code></pre></div>
<p>Importing tables into a list in the global R environment is
convenient for downstream analysis, but can take up a lot of working
memory. If working memory is limiting, you can bypass this step by
setting the fetch_option as “save.only”. The save_option argument allows
you to specify how you want the tables saved. The default is an R data
object with a list of tables (“list”). You can also save tables as
separate rds or csv files. For systems with limited working memory, it
may work better to save tables as separate files and load individual
tables as needed.</p>
<p>Users who plan to work with the data tables outside of R may want to
save the tables into separate CSV files locally:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">import_db_tables</span>(<span class="at">fetch_option =</span> <span class="st">&quot;save.only&quot;</span>,</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>                       <span class="at">save_option =</span> <span class="st">&quot;csv&quot;</span>,</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>                       <span class="at">savedir =</span> <span class="st">&quot;myChosenFolder&quot;</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>                       <span class="at">savename =</span> <span class="st">&quot;drives&quot;</span> </span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>                       )</span></code></pre></div>
</div>
<div id="database-metadata" class="section level2">
<h2>Database metadata</h2>
<p>The database contains three data dictionary tables with detailed
descriptions about tables, columns within tables, and categorical
variables. The column dictionary includes the details used to generate
the database schema, including primary keys and foreign key
relationships.</p>
<p>Dictionary tables can be downloaded individually, using the
<em>get_db_table</em> function, or all at once as a list with
<em>import_dictionary_tables</em>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="do">## separate:</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>table_dictionary <span class="ot">&lt;-</span> <span class="fu">get_db_table</span>(<span class="st">&quot;table_dictionary&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>column_dictionary <span class="ot">&lt;-</span> <span class="fu">get_db_table</span>(<span class="st">&quot;column_dictionary&quot;</span>)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="do">## together:</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>dict <span class="ot">&lt;-</span> <span class="fu">import_dictionary_tables</span>()</span></code></pre></div>
<p>If you’re interested in seeing how the database is structured in
Directus, you can use the <em>get_db_info</em> function to view metadata
for any endpoint in the API. The example below shows metadata for the
table dictionary. The output can be formatted as a json or a dataframe.
The json option is a clearer representation of how information is
structured in Directus. See <a href="https://directus.io/docs/api">https://directus.io/docs/api</a>.
For more information on the Directus API.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>table_dict_info <span class="ot">&lt;-</span> <span class="fu">get_db_info</span>(<span class="at">mytarget =</span> <span class="st">&quot;collections/table_dictionary&quot;</span>,</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>                             <span class="at">output_format =</span> <span class="st">&quot;json&quot;</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="fu">print</span>(table_dict_info)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co">#&gt;     &quot;data&quot;: {</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">#&gt;         &quot;collection&quot;: &quot;table_dictionary&quot;,</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">#&gt;         &quot;meta&quot;: {</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="co">#&gt;             &quot;collection&quot;: &quot;table_dictionary&quot;,</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">#&gt;             &quot;icon&quot;: null,</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co">#&gt;             &quot;note&quot;: &quot;Describes tables within the DRIVES database (you&#39;re reading it now!). \n One row per table. &quot;,</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co">#&gt;             &quot;display_template&quot;: null,</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co">#&gt;             &quot;hidden&quot;: false,</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="co">#&gt;             &quot;singleton&quot;: false,</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="co">#&gt;             &quot;translations&quot;: null,</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">#&gt;             &quot;archive_field&quot;: null,</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="co">#&gt;             &quot;archive_app_filter&quot;: true,</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="co">#&gt;             &quot;archive_value&quot;: null,</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="co">#&gt;             &quot;unarchive_value&quot;: null,</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="co">#&gt;             &quot;sort_field&quot;: null,</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="co">#&gt;             &quot;accountability&quot;: &quot;all&quot;,</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a><span class="co">#&gt;             &quot;color&quot;: null,</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a><span class="co">#&gt;             &quot;item_duplication_fields&quot;: null,</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="co">#&gt;             &quot;sort&quot;: null,</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a><span class="co">#&gt;             &quot;group&quot;: null,</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a><span class="co">#&gt;             &quot;collapse&quot;: &quot;open&quot;,</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a><span class="co">#&gt;             &quot;preview_url&quot;: null,</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="co">#&gt;             &quot;versioning&quot;: false</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a><span class="co">#&gt;         },</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a><span class="co">#&gt;         &quot;schema&quot;: {</span></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a><span class="co">#&gt;             &quot;schema&quot;: &quot;public&quot;,</span></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a><span class="co">#&gt;             &quot;name&quot;: &quot;table_dictionary&quot;,</span></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a><span class="co">#&gt;             &quot;comment&quot;: null</span></span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a><span class="co">#&gt;         }</span></span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a><span class="co">#&gt;     }</span></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a><span class="co">#&gt; </span></span></code></pre></div>
<p>One detail to note is that non-dictionary tables with approved public
viewer access have a prefix “public_”. This only comes up when viewing
tables in the <a href="https://data.drives-network.org/admin/login">Directus Studio
App</a> or specifying API endpoints directly, as shown below.</p>
</div>
</div>
<div id="harmonizing-drives-tables" class="section level1">
<h1>Harmonizing DRIVES tables</h1>
<p>The DRIVES database was designed to be flexible for various end-uses
and preserve as much information as possible within each experiment. The
relational database design is useful for these objectives, but adds a
layer of difficulty for analyzing the data. Therefore, the drivesR
package provides data harmonization functions that reshape and combine
data tables to ease downstream analysis. Each function has arguments to
facilitate different end uses. We start with lower-level harmonization
functions that preserve information in individual tables, then higher
level functions that combine tables with some loss of information.</p>
<div id="crop-yields" class="section level3">
<h3>1) Crop yields:</h3>
<p>The <em>harmonize_yields</em> function performs useful operations on
the crop_yields table. If the table is already downloaded, it can be
used as an argument. Otherwise, the function downloads the table using
the Directus API.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="do">## without pre-downloaded tables:</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>yields <span class="ot">&lt;-</span> <span class="fu">harmonize_yields</span>()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="do">## with pre-downloaded tables:</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>crop_yields <span class="ot">&lt;-</span> <span class="fu">get_db_table</span>(<span class="st">&quot;crop_yields&quot;</span>)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>yields <span class="ot">&lt;-</span> <span class="fu">harmonize_yields</span>(crop_yields)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="do">## or, if in a list:</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>yields <span class="ot">&lt;-</span> <span class="fu">harmonize_yields</span>(db<span class="sc">$</span>crop_yields)</span></code></pre></div>
<p>The function performs some light processing steps, such as
calculating dry yields and adding a TRUE or FALSE column for cover
crops. It also provides the option to keep crop fractions from the same
crop/unit/year (e.g. grain and straw) in separate rows, to rearrange
them into columns.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="do">## crop fractions in rows</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#crop_yields &lt;- get_db_table(&quot;crop_yields&quot;)</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>yields <span class="ot">&lt;-</span> <span class="fu">harmonize_yields</span>(db<span class="sc">$</span>crop_yields) <span class="co"># could be a separate dataframe or part of a list</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>longyields <span class="ot">&lt;-</span> <span class="fu">harmonize_yields</span>(db<span class="sc">$</span>crop_yields,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>                               <span class="at">crop_fractions_as_columns =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="fu">dim</span>(longyields)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#&gt; [1] 65839    18</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="fu">names</span>(longyields)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;uid&quot;                         &quot;site_id&quot;                     &quot;unit_id&quot;                    </span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;harvest_year&quot;                &quot;rotation_phase&quot;              &quot;stand_year&quot;                 </span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;num_harvests&quot;                &quot;expected_crop_id&quot;            &quot;actual_crop_id&quot;             </span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#&gt; [10] &quot;measured_fraction&quot;           &quot;removed_from_field_tf&quot;       &quot;dry_yield_kg_ha&quot;            </span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">#&gt; [13] &quot;yield_kg_ha&quot;                 &quot;yield_percent_moisture&quot;      &quot;moisture_type&quot;              </span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#&gt; [16] &quot;percent_moisture_at_harvest&quot; &quot;data_processing_note&quot;        &quot;cover_crop&quot;</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="do">## crop fractions in columns</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>wideyields <span class="ot">&lt;-</span> <span class="fu">harmonize_yields</span>(db<span class="sc">$</span>crop_yields,</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>                               <span class="at">crop_fractions_as_columns =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="fu">dim</span>(wideyields)</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; [1] 47021    40</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="fu">names</span>(wideyields) <span class="co"># columns include suffix _1 for the primary fraction and _2, _3, etc. for other fractions.</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;                       &quot;unit_id&quot;                       &quot;harvest_year&quot;                 </span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;actual_crop_id&quot;                &quot;stand_year&quot;                    &quot;num_harvests&quot;                 </span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;rotation_phase&quot;                &quot;uid_1&quot;                         &quot;uid_2&quot;                        </span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt; [10] &quot;uid_3&quot;                         &quot;expected_crop_id_1&quot;            &quot;expected_crop_id_2&quot;           </span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#&gt; [13] &quot;expected_crop_id_3&quot;            &quot;measured_fraction_1&quot;           &quot;measured_fraction_2&quot;          </span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt; [16] &quot;measured_fraction_3&quot;           &quot;removed_from_field_tf_1&quot;       &quot;removed_from_field_tf_2&quot;      </span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; [19] &quot;removed_from_field_tf_3&quot;       &quot;dry_yield_kg_ha_1&quot;             &quot;dry_yield_kg_ha_2&quot;            </span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#&gt; [22] &quot;dry_yield_kg_ha_3&quot;             &quot;yield_kg_ha_1&quot;                 &quot;yield_kg_ha_2&quot;                </span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a><span class="co">#&gt; [25] &quot;yield_kg_ha_3&quot;                 &quot;yield_percent_moisture_1&quot;      &quot;yield_percent_moisture_2&quot;     </span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co">#&gt; [28] &quot;yield_percent_moisture_3&quot;      &quot;moisture_type_1&quot;               &quot;moisture_type_2&quot;              </span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co">#&gt; [31] &quot;moisture_type_3&quot;               &quot;percent_moisture_at_harvest_1&quot; &quot;percent_moisture_at_harvest_2&quot;</span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="co">#&gt; [34] &quot;percent_moisture_at_harvest_3&quot; &quot;data_processing_note_1&quot;        &quot;data_processing_note_2&quot;       </span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="co">#&gt; [37] &quot;data_processing_note_3&quot;        &quot;cover_crop_1&quot;                  &quot;cover_crop_2&quot;                 </span></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="co">#&gt; [40] &quot;cover_crop_3&quot;</span></span></code></pre></div>
</div>
<div id="experimental-treatments-and-design" class="section level2">
<h2>2) Experimental treatments and design:</h2>
<p>Information about experimental treatments and design is organized
across multiple tables in the DRIVES database. Some of these tables are
useful to interact with directly. Others require harmonization to be
useful for analysis.</p>
<ul>
<li><p><strong>site_treatment_type_info</strong>: Provides information
about types of experimental treatments at a site level. Treatments
correspond to a core set of management practices described for all
sites. The table includes textual descriptions and information about how
the treatments factor into the experimental design. This is a useful
starting point for evaluating management practices represented in the
DRIVES database and possibilities for analysis.</p></li>
<li><p><strong>site_treatment_level_info</strong>: Provides information
about the levels within each treatment within
<em>site_treatment_type_info</em>).</p></li>
<li><p><strong>rotation_id_info</strong>: Since the DRIVES project is
centered around crop rotations, rotation information has its own set of
tables separate from other treatments. Each site-specific rotation is
assigned a unique rotation_id, described in this table, along with
useful overview information such as the length, species richness, and
inclusion of cover crops or perennials. This rotation_id is included in
<em>treatment_id_components</em>.</p></li>
<li><p><strong>rotation_phases</strong>: Provides detailed information
about the cropping sequence for each rotation_id. This includes crop
identifiers, timing of planting and harvest, crop functions (e.g.,
grain, cover), and what is done with different crop fractions (whether
they’re measured, removed, retained).</p></li>
<li><p><strong>treatment_id_info</strong>: Combinations of practices
applied to the same experimental unit are assigned a unique
treatment_id. There are two types of treatment ids: those assigned based
on management practices alone (treatmentID1), and those assigned based
on management practices plus staggered rotation phases (treatmentID2).
This table lists each treatment identifier, its type, and its
corresponding site_id. It mainly exists to be merged into the next
table.</p></li>
<li><p><strong>treatment_id_components</strong>: Specifies the component
treatment levels for each treatment_id. The treatment levels relate back
to site_treatment_level_info and rotation_id_info. The table is
structured with a start and end year to each treatment components to
accommodate changes over time.</p></li>
<li><p><strong>experimental_unit_info</strong>: Provides spatial and
design information about experimental units. Information includes the
type of unit (split-plot, plot, block, etc.), relative position within
the field, directional orientation, and any parent units (for
split-plots within plots, plots within blocks. etc.).</p></li>
<li><p><strong>experimental_unit_treatments</strong>: Indicates which
treatment_ids were applied to which experimental units in which years,
organized as start year and end year.</p></li>
</ul>
<p>The <em>harmonize_treatments</em> function takes information from
<em>treatment_id_info</em> and <em>treatment_id_components</em> and
expands them into a time-series data set with one row per
treatment_id/year and separate columns for each treatment component.
This can be useful for exploratory analysis of experimental designs. The
function accepts a list of database tables named
<em>treatment_id_info</em> and <em>treatment_id_components</em>. If
those are not provided, it fetches those tables from the Directus
database.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="do">## tables provided</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>trt <span class="ot">&lt;-</span> <span class="fu">harmonize_treatments</span>(db) <span class="co"># db is a named list with &#39;treatment_id_info&#39; and &#39;treatment_id_components&#39;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co"># tables not provided</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>trt <span class="ot">&lt;-</span> <span class="fu">harmonize_treatments</span>()</span></code></pre></div>
<p>The harmonize_treatments_units function produces a dataframe with one
row per unit_id and year, and separate columns for each treatment id and
component. This structure allows it to be merged with yield data.
Similar to other harmonization functions, it accepts a named list or
fetches tables from the database.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="do">## tables provided</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>trtunit <span class="ot">&lt;-</span> <span class="fu">harmonize_treatments_units</span>(db) <span class="co"># db is a named list with &#39;treatment_id_info&#39;, &#39;treatment_id_components&#39;, and &#39;experimental_unit_treatments&#39;</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co"># tables not provided</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>trtunit <span class="ot">&lt;-</span> <span class="fu">harmonize_treatments_units</span>()</span></code></pre></div>
<p>The full dataframe with all treatment components may be a little
daunting. We made a function list_treatment_types_by_management_practice
to help subset column names corresponding to particular management
practices. This uses information in the site_treatment_type_info table.
The function accepts this table as an argument, or fetches it from the
database.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>trt <span class="ot">&lt;-</span> <span class="fu">harmonize_treatments</span>(db)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>trtlist <span class="ot">&lt;-</span> <span class="fu">list_treatments_by_management_practice</span>(db<span class="sc">$</span>site_treatment_type_info)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co"># lets say I wanted to extract information on N fertility treatments</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>trtcolz <span class="ot">&lt;-</span> trtlist<span class="sc">$</span><span class="st">`</span><span class="at">N fertility</span><span class="st">`</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>trtsubset <span class="ot">&lt;-</span> trt[<span class="fu">c</span>(<span class="st">&quot;site_id&quot;</span>,<span class="st">&quot;year&quot;</span>, trtcolz)]</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="fu">head</span>(trtsubset)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">#&gt;   site_id year         N fertility nutrient management system N rate soil amendment</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">#&gt; 1   CATCE 2013 low input synthetic                       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="co">#&gt; 2   CATCE 2014 low input synthetic                       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="co">#&gt; 3   CATCE 2015 low input synthetic                       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="co">#&gt; 4   CATCE 2016 low input synthetic                       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="co">#&gt; 5   CATCE 2017 low input synthetic                       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="co">#&gt; 6   CATCE 2018 low input synthetic                       &lt;NA&gt;   &lt;NA&gt;           &lt;NA&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="co">#&gt;   grassland N addition</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="co">#&gt; 1                 &lt;NA&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="co">#&gt; 2                 &lt;NA&gt;</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a><span class="co">#&gt; 3                 &lt;NA&gt;</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="co">#&gt; 4                 &lt;NA&gt;</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="co">#&gt; 5                 &lt;NA&gt;</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="co">#&gt; 6                 &lt;NA&gt;</span></span></code></pre></div>
</div>
<div id="management-data" class="section level2">
<h2>3) Management data</h2>
<p>Currently, the DRIVES database has two tables with time-series
management details.</p>
<ul>
<li><em>planting_info</em> provides planting dates, variety identifiers,
and seeding rates for every unit/year/crop where available. It includes
separate rows for components of crop mixtures and for replanting, if
earlier plantings failied. This level of detail makes the data a little
difficult to work with.</li>
</ul>
<p>The harmonize_planting_info function offers several options to
simplify the planting_info table into one row per unit/year/crop/date.
Multiple planting dates can be retained in separate rows or columns, or
trimmed to include only the latest planting date. Component crops within
mixtures can be retained as separate columns or excluded. See
?harmonize_planting_info for details on options and output.</p>
<p>Like other harmonization functions, it can accept the planting_info
table as an input or fetch it from the database.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">#planting_info &lt;- get_db_table(&quot;planting_info&quot;) # can be a separate table or part of a list.</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">harmonize_planting_info</span>(db<span class="sc">$</span>planting_info, <span class="at">replant_dates =</span> <span class="st">&quot;latest&quot;</span>,<span class="at">include_component_crops =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="fu">dim</span>(p1)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">#&gt; [1] 44537    53</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="fu">names</span>(p1)<span class="co"># names have a numbered suffix for component crops in mixtures.</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;              &quot;unit_id&quot;              &quot;harvest_year&quot;         &quot;expected_crop_id&quot;    </span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="co">#&gt;  [5] &quot;actual_crop_id&quot;       &quot;stand_year&quot;           &quot;rotation_phase&quot;       &quot;planting_date&quot;       </span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;date_index&quot;           &quot;replantedTF&quot;          &quot;component_crop_id_2&quot;  &quot;component_crop_id_1&quot; </span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="co">#&gt; [13] &quot;component_crop_id_3&quot;  &quot;component_crop_id_5&quot;  &quot;component_crop_id_4&quot;  &quot;component_crop_id_6&quot; </span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="co">#&gt; [17] &quot;component_crop_id_10&quot; &quot;component_crop_id_9&quot;  &quot;component_crop_id_7&quot;  &quot;component_crop_id_8&quot; </span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="co">#&gt; [21] &quot;variety_id_2&quot;         &quot;variety_id_1&quot;         &quot;variety_id_3&quot;         &quot;variety_id_5&quot;        </span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">#&gt; [25] &quot;variety_id_4&quot;         &quot;variety_id_6&quot;         &quot;variety_id_10&quot;        &quot;variety_id_9&quot;        </span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="co">#&gt; [29] &quot;variety_id_7&quot;         &quot;variety_id_8&quot;         &quot;planting_rate_2&quot;      &quot;planting_rate_1&quot;     </span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="co">#&gt; [33] &quot;planting_rate_3&quot;      &quot;planting_rate_5&quot;      &quot;planting_rate_4&quot;      &quot;planting_rate_6&quot;     </span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="co">#&gt; [37] &quot;planting_rate_10&quot;     &quot;planting_rate_9&quot;      &quot;planting_rate_7&quot;      &quot;planting_rate_8&quot;     </span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="co">#&gt; [41] &quot;uid_2&quot;                &quot;uid_1&quot;                &quot;uid_3&quot;                &quot;uid_5&quot;               </span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="co">#&gt; [45] &quot;uid_4&quot;                &quot;uid_6&quot;                &quot;uid_10&quot;               &quot;uid_9&quot;               </span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="co">#&gt; [49] &quot;uid_7&quot;                &quot;uid_8&quot;                &quot;planting_units&quot;       &quot;material_planted&quot;    </span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="co">#&gt; [53] &quot;planting_notes&quot;</span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="co"># And since replant_dates = &#39;latest&#39;, there is an added column replantedTF indicating whether a unit was replanted.</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">harmonize_planting_info</span>(db<span class="sc">$</span>planting_info, <span class="at">replant_dates =</span> <span class="st">&quot;rows&quot;</span>,<span class="at">include_component_crops =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="fu">dim</span>(p2)</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="co">#&gt; [1] 45019    18</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="fu">names</span>(p2) <span class="co"># All planting dates are included and organized under a date_index column. Since include_component_crops is FALSE, there is an added column num_components providing the number of component crops within each actual_crop_id.</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;uid&quot;                 &quot;site_id&quot;             &quot;unit_id&quot;             &quot;expected_crop_id&quot;   </span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="co">#&gt;  [5] &quot;actual_crop_id&quot;      &quot;stand_year&quot;          &quot;rotation_phase&quot;      &quot;phase_year_planting&quot;</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;harvest_year&quot;        &quot;planting_year&quot;       &quot;planting_date&quot;       &quot;variety_id&quot;         </span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="co">#&gt; [13] &quot;planting_rate&quot;       &quot;planting_units&quot;      &quot;material_planted&quot;    &quot;planting_notes&quot;     </span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="co">#&gt; [17] &quot;date_index&quot;          &quot;num_components&quot;</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">harmonize_planting_info</span>(db<span class="sc">$</span>planting_info, <span class="at">replant_dates =</span> <span class="st">&quot;columns&quot;</span>,<span class="at">include_component_crops =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="fu">dim</span>(p3)</span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="co">#&gt; [1] 44537    85</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a><span class="fu">names</span>(p3) <span class="co"># names include suffixes d and c for planting dates and component crops, respectively.</span></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;                  &quot;unit_id&quot;                  &quot;expected_crop_id&quot;        </span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;actual_crop_id&quot;           &quot;stand_year&quot;               &quot;rotation_phase&quot;          </span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;harvest_year&quot;             &quot;component_crop_id_d1_c2&quot;  &quot;component_crop_id_d1_c1&quot; </span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a><span class="co">#&gt; [10] &quot;component_crop_id_d2_c1&quot;  &quot;component_crop_id_d1_c3&quot;  &quot;component_crop_id_d3_c1&quot; </span></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="co">#&gt; [13] &quot;component_crop_id_d1_c5&quot;  &quot;component_crop_id_d1_c4&quot;  &quot;component_crop_id_d1_c6&quot; </span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="co">#&gt; [16] &quot;component_crop_id_d1_c10&quot; &quot;component_crop_id_d1_c9&quot;  &quot;component_crop_id_d1_c7&quot; </span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="co">#&gt; [19] &quot;component_crop_id_d1_c8&quot;  &quot;component_crop_id_d3_c2&quot;  &quot;component_crop_id_d2_c2&quot; </span></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a><span class="co">#&gt; [22] &quot;component_crop_id_d4_c1&quot;  &quot;planting_date_d1_c2&quot;      &quot;planting_date_d1_c1&quot;     </span></span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a><span class="co">#&gt; [25] &quot;planting_date_d2_c1&quot;      &quot;planting_date_d1_c3&quot;      &quot;planting_date_d3_c1&quot;     </span></span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a><span class="co">#&gt; [28] &quot;planting_date_d1_c5&quot;      &quot;planting_date_d1_c4&quot;      &quot;planting_date_d1_c6&quot;     </span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a><span class="co">#&gt; [31] &quot;planting_date_d1_c10&quot;     &quot;planting_date_d1_c9&quot;      &quot;planting_date_d1_c7&quot;     </span></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a><span class="co">#&gt; [34] &quot;planting_date_d1_c8&quot;      &quot;planting_date_d3_c2&quot;      &quot;planting_date_d2_c2&quot;     </span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a><span class="co">#&gt; [37] &quot;planting_date_d4_c1&quot;      &quot;variety_id_d1_c2&quot;         &quot;variety_id_d1_c1&quot;        </span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a><span class="co">#&gt; [40] &quot;variety_id_d2_c1&quot;         &quot;variety_id_d1_c3&quot;         &quot;variety_id_d3_c1&quot;        </span></span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a><span class="co">#&gt; [43] &quot;variety_id_d1_c5&quot;         &quot;variety_id_d1_c4&quot;         &quot;variety_id_d1_c6&quot;        </span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a><span class="co">#&gt; [46] &quot;variety_id_d1_c10&quot;        &quot;variety_id_d1_c9&quot;         &quot;variety_id_d1_c7&quot;        </span></span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a><span class="co">#&gt; [49] &quot;variety_id_d1_c8&quot;         &quot;variety_id_d3_c2&quot;         &quot;variety_id_d2_c2&quot;        </span></span>
<span id="cb19-53"><a href="#cb19-53" tabindex="-1"></a><span class="co">#&gt; [52] &quot;variety_id_d4_c1&quot;         &quot;planting_rate_d1_c2&quot;      &quot;planting_rate_d1_c1&quot;     </span></span>
<span id="cb19-54"><a href="#cb19-54" tabindex="-1"></a><span class="co">#&gt; [55] &quot;planting_rate_d2_c1&quot;      &quot;planting_rate_d1_c3&quot;      &quot;planting_rate_d3_c1&quot;     </span></span>
<span id="cb19-55"><a href="#cb19-55" tabindex="-1"></a><span class="co">#&gt; [58] &quot;planting_rate_d1_c5&quot;      &quot;planting_rate_d1_c4&quot;      &quot;planting_rate_d1_c6&quot;     </span></span>
<span id="cb19-56"><a href="#cb19-56" tabindex="-1"></a><span class="co">#&gt; [61] &quot;planting_rate_d1_c10&quot;     &quot;planting_rate_d1_c9&quot;      &quot;planting_rate_d1_c7&quot;     </span></span>
<span id="cb19-57"><a href="#cb19-57" tabindex="-1"></a><span class="co">#&gt; [64] &quot;planting_rate_d1_c8&quot;      &quot;planting_rate_d3_c2&quot;      &quot;planting_rate_d2_c2&quot;     </span></span>
<span id="cb19-58"><a href="#cb19-58" tabindex="-1"></a><span class="co">#&gt; [67] &quot;planting_rate_d4_c1&quot;      &quot;uid_d1_c2&quot;                &quot;uid_d1_c1&quot;               </span></span>
<span id="cb19-59"><a href="#cb19-59" tabindex="-1"></a><span class="co">#&gt; [70] &quot;uid_d2_c1&quot;                &quot;uid_d1_c3&quot;                &quot;uid_d3_c1&quot;               </span></span>
<span id="cb19-60"><a href="#cb19-60" tabindex="-1"></a><span class="co">#&gt; [73] &quot;uid_d1_c5&quot;                &quot;uid_d1_c4&quot;                &quot;uid_d1_c6&quot;               </span></span>
<span id="cb19-61"><a href="#cb19-61" tabindex="-1"></a><span class="co">#&gt; [76] &quot;uid_d1_c10&quot;               &quot;uid_d1_c9&quot;                &quot;uid_d1_c7&quot;               </span></span>
<span id="cb19-62"><a href="#cb19-62" tabindex="-1"></a><span class="co">#&gt; [79] &quot;uid_d1_c8&quot;                &quot;uid_d3_c2&quot;                &quot;uid_d2_c2&quot;               </span></span>
<span id="cb19-63"><a href="#cb19-63" tabindex="-1"></a><span class="co">#&gt; [82] &quot;uid_d4_c1&quot;                &quot;planting_notes&quot;           &quot;planting_units&quot;          </span></span>
<span id="cb19-64"><a href="#cb19-64" tabindex="-1"></a><span class="co">#&gt; [85] &quot;material_planted&quot;</span></span></code></pre></div>
<p><em>harvest_dates</em> provides harvest dates for every
unit/year/crop where available. It includes separate rows for multiple
harvest dates (typical for forages) and for crop fractions harvested on
different dates (rare).</p>
<p>The harmonize_harvest_dates function reshapes the harvest_dates table
so multiple harvests are in separate columns (one row per
unit/year/crop). It has an option to put crop fractions with different
harvest dates in separate columns (rarely an issue).</p>
<p>Like other harmonization functions, it can accept the planting_info
table as an input or fetch it from the database</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">#harvest_dates &lt;- get_db_table(&quot;harvest_dates&quot;)# can be a separate table or part of a list.</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>h1 <span class="ot">&lt;-</span> <span class="fu">harmonize_harvest_dates</span>(db<span class="sc">$</span>harvest_dates, <span class="at">crop_fractions_as_columns =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="fu">dim</span>(h1)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co">#&gt; [1] 45299    26</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="fu">names</span>(h1)</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;            &quot;unit_id&quot;            &quot;expected_crop_id&quot;   &quot;actual_crop_id&quot;    </span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co">#&gt;  [5] &quot;stand_year&quot;         &quot;rotation_phase&quot;     &quot;phase_year_harvest&quot; &quot;harvest_year&quot;      </span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;harvested_fraction&quot; &quot;harvest_notes&quot;      &quot;termination_date&quot;   &quot;termination_notes&quot; </span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co">#&gt; [13] &quot;harvest_date_1&quot;     &quot;harvest_date_2&quot;     &quot;harvest_date_3&quot;     &quot;harvest_date_4&quot;    </span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co">#&gt; [17] &quot;harvest_date_5&quot;     &quot;harvest_date_6&quot;     &quot;harvest_date_7&quot;     &quot;uid_1&quot;             </span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="co">#&gt; [21] &quot;uid_2&quot;              &quot;uid_3&quot;              &quot;uid_4&quot;              &quot;uid_5&quot;             </span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a><span class="co">#&gt; [25] &quot;uid_6&quot;              &quot;uid_7&quot;</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>h2 <span class="ot">&lt;-</span> <span class="fu">harmonize_harvest_dates</span>(db<span class="sc">$</span>harvest_dates, <span class="at">crop_fractions_as_columns =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a><span class="fu">dim</span>(h2) <span class="co"># only slightly different.</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a><span class="co">#&gt; [1] 45267    32</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a><span class="fu">names</span>(h2)</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;              &quot;unit_id&quot;              &quot;expected_crop_id&quot;     &quot;actual_crop_id&quot;      </span></span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a><span class="co">#&gt;  [5] &quot;stand_year&quot;           &quot;rotation_phase&quot;       &quot;phase_year_harvest&quot;   &quot;harvest_year&quot;        </span></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a><span class="co">#&gt;  [9] &quot;harvest_notes&quot;        &quot;termination_date&quot;     &quot;termination_notes&quot;    &quot;harvest_date_1&quot;      </span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a><span class="co">#&gt; [13] &quot;harvest_date_2&quot;       &quot;harvest_date_3&quot;       &quot;harvest_date_4&quot;       &quot;harvest_date_5&quot;      </span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a><span class="co">#&gt; [17] &quot;harvest_date_6&quot;       &quot;harvest_date_7&quot;       &quot;harvested_fraction_1&quot; &quot;harvested_fraction_2&quot;</span></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a><span class="co">#&gt; [21] &quot;harvested_fraction_3&quot; &quot;harvested_fraction_4&quot; &quot;harvested_fraction_5&quot; &quot;harvested_fraction_6&quot;</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a><span class="co">#&gt; [25] &quot;harvested_fraction_7&quot; &quot;uid_1&quot;                &quot;uid_2&quot;                &quot;uid_3&quot;               </span></span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a><span class="co">#&gt; [29] &quot;uid_4&quot;                &quot;uid_5&quot;                &quot;uid_6&quot;                &quot;uid_7&quot;</span></span></code></pre></div>
</div>
<div id="weather" class="section level2">
<h2>6) Weather</h2>
<p>The DRIVES database contains two tables pertaining to weather:
<strong>weather_daily</strong> contains daily weather station data for
min and max precipitation and cumulative precipitation. Missing
observations are supplied from gridded data from <a href="https://daymet.ornl.gov/">Daymet</a>. The table is organized in a
long format, with weather variables in separate rows.
<strong>weather_station_info</strong> provides information on weather
station identifiers used in the weather_daily data. This includes their
lat-lon coordinates and urls for data access (if applicable).</p>
<p>The <em>harmonize_weather</em> function converts the daily weather
table from long to wide and removes columns that are not useful in a
wide format.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">#weather_daily &lt;- get_db_table(&quot;weather_daily&quot;)# can be a separate table or part of a list.</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="fu">str</span>(db<span class="sc">$</span>weather_daily) <span class="co"># long version</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="co">#&gt; &#39;data.frame&#39;:    732322 obs. of  9 variables:</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co">#&gt;  $ uid               : int  95329 95330 95331 95332 95333 95334 95335 95336 95337 95338 ...</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co">#&gt;  $ site_id           : chr  &quot;CATCE&quot; &quot;CATCE&quot; &quot;CATCE&quot; &quot;CATCE&quot; ...</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co">#&gt;  $ weather_station_id: chr  &quot;CATCE_ST2&quot; &quot;CATCE_ST2&quot; &quot;CATCE_ST2&quot; &quot;CATCE_ST2&quot; ...</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#&gt;  $ year              : int  1978 1978 1978 1978 1978 1978 1978 1978 1978 1978 ...</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#&gt;  $ date              : chr  &quot;1978-01-01&quot; &quot;1978-01-01&quot; &quot;1978-01-01&quot; &quot;1978-01-02&quot; ...</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#&gt;  $ day_of_year       : int  1 1 1 2 2 2 3 3 3 4 ...</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">#&gt;  $ variable          : chr  &quot;air_temp_min_c&quot; &quot;air_temp_max_c&quot; &quot;precip_mm&quot; &quot;air_temp_min_c&quot; ...</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co">#&gt;  $ value             : num  4.4 13.9 0 7.8 15 1.3 7.8 13.9 4.6 8.3 ...</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="co">#&gt;  $ flag              : chr  NA NA NA NA ...</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>weatherdf <span class="ot">&lt;-</span> <span class="fu">harmonize_weather</span>(db<span class="sc">$</span>weather_daily)</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="fu">str</span>(weatherdf) <span class="co"># wide simplified version</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co">#&gt; tibble [244,108 x 7] (S3: tbl_df/tbl/data.frame)</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co">#&gt;  $ site_id       : chr [1:244108] &quot;CATCE&quot; &quot;CATCE&quot; &quot;CATCE&quot; &quot;CATCE&quot; ...</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">#&gt;  $ year          : int [1:244108] 1978 1978 1978 1978 1978 1978 1978 1978 1978 1978 ...</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co">#&gt;  $ date          : chr [1:244108] &quot;1978-01-01&quot; &quot;1978-01-02&quot; &quot;1978-01-03&quot; &quot;1978-01-04&quot; ...</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co">#&gt;  $ day_of_year   : int [1:244108] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="co">#&gt;  $ air_temp_min_c: num [1:244108] 4.4 7.8 7.8 8.3 10 9.4 5.6 10 11.7 10 ...</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co">#&gt;  $ air_temp_max_c: num [1:244108] 13.9 15 13.9 11.7 12.8 13.3 15 13.9 14.4 16.1 ...</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="co">#&gt;  $ precip_mm     : num [1:244108] 0 1.3 4.6 4.3 29.7 23.1 0.3 1.3 24.9 4.3 ...</span></span></code></pre></div>
</div>
<div id="putting-it-all-together" class="section level2">
<h2>5) Putting it all together</h2>
<p>The <em>harmonize_yields_treatments</em> function combines the
harmonization steps for treatments, units, and yields and merges them
together. It includes the option to keep crop fractions in separate rows
or reorganize them into columns. It can operate on a list of
pre-downloaded tables, or fetch the tables from Directus.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># db &lt;- import_db_tables(c(&quot;treatment_id_info&quot;,&quot;treatment_id_components&quot;,&quot;experimental_unit_treatments&quot;,&quot;crop_yields&quot;),fetch_option = &quot;download.only&quot;)</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>hyt <span class="ot">&lt;-</span> <span class="fu">harmonize_yields_treatments</span>(db, <span class="at">crop_fractions_as_columns =</span> <span class="cn">TRUE</span>) </span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="fu">names</span>(hyt) <span class="co">#names will have numbered suffixes for crop fractions.</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;                       &quot;unit_id&quot;                       &quot;harvest_year&quot;                 </span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;actual_crop_id&quot;                &quot;stand_year&quot;                    &quot;num_harvests&quot;                 </span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;rotation_phase&quot;                &quot;uid_1&quot;                         &quot;uid_2&quot;                        </span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="co">#&gt; [10] &quot;uid_3&quot;                         &quot;expected_crop_id_1&quot;            &quot;expected_crop_id_2&quot;           </span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co">#&gt; [13] &quot;expected_crop_id_3&quot;            &quot;measured_fraction_1&quot;           &quot;measured_fraction_2&quot;          </span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co">#&gt; [16] &quot;measured_fraction_3&quot;           &quot;removed_from_field_tf_1&quot;       &quot;removed_from_field_tf_2&quot;      </span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co">#&gt; [19] &quot;removed_from_field_tf_3&quot;       &quot;dry_yield_kg_ha_1&quot;             &quot;dry_yield_kg_ha_2&quot;            </span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a><span class="co">#&gt; [22] &quot;dry_yield_kg_ha_3&quot;             &quot;yield_kg_ha_1&quot;                 &quot;yield_kg_ha_2&quot;                </span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co">#&gt; [25] &quot;yield_kg_ha_3&quot;                 &quot;yield_percent_moisture_1&quot;      &quot;yield_percent_moisture_2&quot;     </span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">#&gt; [28] &quot;yield_percent_moisture_3&quot;      &quot;moisture_type_1&quot;               &quot;moisture_type_2&quot;              </span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="co">#&gt; [31] &quot;moisture_type_3&quot;               &quot;percent_moisture_at_harvest_1&quot; &quot;percent_moisture_at_harvest_2&quot;</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a><span class="co">#&gt; [34] &quot;percent_moisture_at_harvest_3&quot; &quot;data_processing_note_1&quot;        &quot;data_processing_note_2&quot;       </span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a><span class="co">#&gt; [37] &quot;data_processing_note_3&quot;        &quot;cover_crop_1&quot;                  &quot;cover_crop_2&quot;                 </span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="co">#&gt; [40] &quot;cover_crop_3&quot;                  &quot;treatmentID1&quot;                  &quot;treatmentID2&quot;                 </span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a><span class="co">#&gt; [43] &quot;rotation_id&quot;                   &quot;entryPhase&quot;                    &quot;cover crop&quot;                   </span></span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a><span class="co">#&gt; [46] &quot;fertilizer amendment class&quot;    &quot;irrigation&quot;                    &quot;N fertility&quot;                  </span></span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a><span class="co">#&gt; [49] &quot;organic management&quot;            &quot;pest management&quot;               &quot;residue management&quot;           </span></span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a><span class="co">#&gt; [52] &quot;tillage&quot;                       &quot;cropping system&quot;               &quot;nutrient management system&quot;   </span></span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a><span class="co">#&gt; [55] &quot;N rate&quot;                        &quot;soil amendment&quot;                &quot;production system&quot;            </span></span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a><span class="co">#&gt; [58] &quot;grassland management&quot;          &quot;grassland N addition&quot;</span></span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a><span class="fu">dim</span>(hyt)</span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a><span class="co">#&gt; [1] 47021    59</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>hyt <span class="ot">&lt;-</span> <span class="fu">harmonize_yields_treatments</span>(db, <span class="at">crop_fractions_as_columns =</span> <span class="cn">FALSE</span>)  </span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a><span class="fu">names</span>(hyt) </span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;uid&quot;                         &quot;site_id&quot;                     &quot;unit_id&quot;                    </span></span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;harvest_year&quot;                &quot;rotation_phase&quot;              &quot;stand_year&quot;                 </span></span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;num_harvests&quot;                &quot;expected_crop_id&quot;            &quot;actual_crop_id&quot;             </span></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a><span class="co">#&gt; [10] &quot;measured_fraction&quot;           &quot;removed_from_field_tf&quot;       &quot;dry_yield_kg_ha&quot;            </span></span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a><span class="co">#&gt; [13] &quot;yield_kg_ha&quot;                 &quot;yield_percent_moisture&quot;      &quot;moisture_type&quot;              </span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a><span class="co">#&gt; [16] &quot;percent_moisture_at_harvest&quot; &quot;data_processing_note&quot;        &quot;cover_crop&quot;                 </span></span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a><span class="co">#&gt; [19] &quot;treatmentID1&quot;                &quot;treatmentID2&quot;                &quot;rotation_id&quot;                </span></span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a><span class="co">#&gt; [22] &quot;entryPhase&quot;                  &quot;cover crop&quot;                  &quot;fertilizer amendment class&quot; </span></span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a><span class="co">#&gt; [25] &quot;irrigation&quot;                  &quot;N fertility&quot;                 &quot;organic management&quot;         </span></span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a><span class="co">#&gt; [28] &quot;pest management&quot;             &quot;residue management&quot;          &quot;tillage&quot;                    </span></span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a><span class="co">#&gt; [31] &quot;cropping system&quot;             &quot;nutrient management system&quot;  &quot;N rate&quot;                     </span></span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a><span class="co">#&gt; [34] &quot;soil amendment&quot;              &quot;production system&quot;           &quot;grassland management&quot;       </span></span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a><span class="co">#&gt; [37] &quot;grassland N addition&quot;</span></span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a><span class="fu">dim</span>(hyt)</span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a><span class="co">#&gt; [1] 65839    37</span></span></code></pre></div>
<p>The <em>harmonize_yields_planting_harvest</em> function combines the
harmonization steps for yields, planting info, and harvest dates. The
only argument is the input list of data tables, which are fetched from
Directus if NULL. Details on component crops and multiple planting dates
from planting_info are excluded. Multiple harvest dates are included as
separate columns, as in <em>harmonize_harvest_dates</em>. Multiple
fractions per crop are included as separate columns with suffixes _f1,
_f2, etc.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">names</span>(db) <span class="co"># full list including yield, planting, and harvest data. </span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;crop_info&quot;                    &quot;crop_variety_info&quot;            &quot;crop_yields&quot;                 </span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;experimental_unit_info&quot;       &quot;experimental_unit_treatments&quot; &quot;harvest_dates&quot;               </span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;planting_info&quot;                &quot;rotation_id_info&quot;             &quot;rotation_phases&quot;             </span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="co">#&gt; [10] &quot;site_info&quot;                    &quot;site_treatment_level_info&quot;    &quot;site_treatment_type_info&quot;    </span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="co">#&gt; [13] &quot;treatment_id_components&quot;      &quot;treatment_id_info&quot;            &quot;weather_daily&quot;               </span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co">#&gt; [16] &quot;weather_station_info&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>yph <span class="ot">&lt;-</span> <span class="fu">harmonize_yields_planting_harvest</span>(db)</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="fu">dim</span>(yph)</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="co">#&gt; [1] 47021    55</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="fu">names</span>(yph)</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;                        &quot;unit_id&quot;                        &quot;harvest_year&quot;                  </span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;expected_crop_id&quot;               &quot;actual_crop_id&quot;                 &quot;stand_year&quot;                    </span></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;num_harvests&quot;                   &quot;rotation_phase&quot;                 &quot;cover_crop&quot;                    </span></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a><span class="co">#&gt; [10] &quot;crop_yields_uid_f1&quot;             &quot;crop_yields_uid_f2&quot;             &quot;crop_yields_uid_f3&quot;            </span></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a><span class="co">#&gt; [13] &quot;measured_fraction_f1&quot;           &quot;measured_fraction_f2&quot;           &quot;measured_fraction_f3&quot;          </span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a><span class="co">#&gt; [16] &quot;removed_from_field_tf_f1&quot;       &quot;removed_from_field_tf_f2&quot;       &quot;removed_from_field_tf_f3&quot;      </span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a><span class="co">#&gt; [19] &quot;dry_yield_kg_ha_f1&quot;             &quot;dry_yield_kg_ha_f2&quot;             &quot;dry_yield_kg_ha_f3&quot;            </span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a><span class="co">#&gt; [22] &quot;yield_kg_ha_f1&quot;                 &quot;yield_kg_ha_f2&quot;                 &quot;yield_kg_ha_f3&quot;                </span></span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a><span class="co">#&gt; [25] &quot;yield_percent_moisture_f1&quot;      &quot;yield_percent_moisture_f2&quot;      &quot;yield_percent_moisture_f3&quot;     </span></span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a><span class="co">#&gt; [28] &quot;moisture_type_f1&quot;               &quot;moisture_type_f2&quot;               &quot;moisture_type_f3&quot;              </span></span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a><span class="co">#&gt; [31] &quot;percent_moisture_at_harvest_f1&quot; &quot;percent_moisture_at_harvest_f2&quot; &quot;data_processing_note_f1&quot;       </span></span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a><span class="co">#&gt; [34] &quot;data_processing_note_f2&quot;        &quot;data_processing_note_f3&quot;        &quot;phase_year_harvest_f1&quot;         </span></span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a><span class="co">#&gt; [37] &quot;phase_year_harvest_f2&quot;          &quot;harvest_notes_f1&quot;               &quot;harvest_notes_f2&quot;              </span></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a><span class="co">#&gt; [40] &quot;harvest_date_1_f1&quot;              &quot;harvest_date_1_f2&quot;              &quot;harvest_dates_uid_1_f1&quot;        </span></span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a><span class="co">#&gt; [43] &quot;harvest_dates_uid_1_f2&quot;         &quot;planting_info_uid&quot;              &quot;phase_year_planting&quot;           </span></span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a><span class="co">#&gt; [46] &quot;planting_year&quot;                  &quot;planting_date&quot;                  &quot;variety_id&quot;                    </span></span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a><span class="co">#&gt; [49] &quot;planting_rate&quot;                  &quot;planting_units&quot;                 &quot;material_planted&quot;              </span></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a><span class="co">#&gt; [52] &quot;planting_notes&quot;                 &quot;date_index&quot;                     &quot;replantedTF&quot;                   </span></span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a><span class="co">#&gt; [55] &quot;num_components&quot;</span></span></code></pre></div>
<p>The <em>harmonize_yields_planting_harvest_treatments</em> function
combines the harmonization steps for yields, planting info, harvest
dates, and experimental treatments to create one giant data table. The
only argument is the input list of data tables, which are fetched from
Directus if NULL. If don’t mind losing some details, you can skip all
the previous data download and harmonization steps (excluding weather
data) and just use this function. The code below fetches the tables from
the database and puts them all together. You can provide a list of
previously downloaded database tables as an input.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>monsterdf <span class="ot">&lt;-</span> <span class="fu">harmonize_yields_planting_harvest_treatments</span>(db)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(treatment_id)`</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="fu">dim</span>(monsterdf)</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co">#&gt; [1] 47021    74</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="fu">names</span>(monsterdf)</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="co">#&gt;  [1] &quot;site_id&quot;                        &quot;unit_id&quot;                        &quot;year&quot;                          </span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="co">#&gt;  [4] &quot;treatmentID1&quot;                   &quot;treatmentID2&quot;                   &quot;rotation_id&quot;                   </span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="co">#&gt;  [7] &quot;entryPhase&quot;                     &quot;cover crop&quot;                     &quot;fertilizer amendment class&quot;    </span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="co">#&gt; [10] &quot;irrigation&quot;                     &quot;N fertility&quot;                    &quot;organic management&quot;            </span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="co">#&gt; [13] &quot;pest management&quot;                &quot;residue management&quot;             &quot;tillage&quot;                       </span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="co">#&gt; [16] &quot;cropping system&quot;                &quot;nutrient management system&quot;     &quot;N rate&quot;                        </span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="co">#&gt; [19] &quot;soil amendment&quot;                 &quot;production system&quot;              &quot;grassland management&quot;          </span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="co">#&gt; [22] &quot;grassland N addition&quot;           &quot;expected_crop_id&quot;               &quot;actual_crop_id&quot;                </span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="co">#&gt; [25] &quot;stand_year&quot;                     &quot;num_harvests&quot;                   &quot;rotation_phase&quot;                </span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="co">#&gt; [28] &quot;cover_crop&quot;                     &quot;crop_yields_uid_f1&quot;             &quot;crop_yields_uid_f2&quot;            </span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a><span class="co">#&gt; [31] &quot;crop_yields_uid_f3&quot;             &quot;measured_fraction_f1&quot;           &quot;measured_fraction_f2&quot;          </span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a><span class="co">#&gt; [34] &quot;measured_fraction_f3&quot;           &quot;removed_from_field_tf_f1&quot;       &quot;removed_from_field_tf_f2&quot;      </span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a><span class="co">#&gt; [37] &quot;removed_from_field_tf_f3&quot;       &quot;dry_yield_kg_ha_f1&quot;             &quot;dry_yield_kg_ha_f2&quot;            </span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a><span class="co">#&gt; [40] &quot;dry_yield_kg_ha_f3&quot;             &quot;yield_kg_ha_f1&quot;                 &quot;yield_kg_ha_f2&quot;                </span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a><span class="co">#&gt; [43] &quot;yield_kg_ha_f3&quot;                 &quot;yield_percent_moisture_f1&quot;      &quot;yield_percent_moisture_f2&quot;     </span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a><span class="co">#&gt; [46] &quot;yield_percent_moisture_f3&quot;      &quot;moisture_type_f1&quot;               &quot;moisture_type_f2&quot;              </span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="co">#&gt; [49] &quot;moisture_type_f3&quot;               &quot;percent_moisture_at_harvest_f1&quot; &quot;percent_moisture_at_harvest_f2&quot;</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a><span class="co">#&gt; [52] &quot;data_processing_note_f1&quot;        &quot;data_processing_note_f2&quot;        &quot;data_processing_note_f3&quot;       </span></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="co">#&gt; [55] &quot;phase_year_harvest_f1&quot;          &quot;phase_year_harvest_f2&quot;          &quot;harvest_notes_f1&quot;              </span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a><span class="co">#&gt; [58] &quot;harvest_notes_f2&quot;               &quot;harvest_date_1_f1&quot;              &quot;harvest_date_1_f2&quot;             </span></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a><span class="co">#&gt; [61] &quot;harvest_dates_uid_1_f1&quot;         &quot;harvest_dates_uid_1_f2&quot;         &quot;planting_info_uid&quot;             </span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a><span class="co">#&gt; [64] &quot;phase_year_planting&quot;            &quot;planting_year&quot;                  &quot;planting_date&quot;                 </span></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a><span class="co">#&gt; [67] &quot;variety_id&quot;                     &quot;planting_rate&quot;                  &quot;planting_units&quot;                </span></span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a><span class="co">#&gt; [70] &quot;material_planted&quot;               &quot;planting_notes&quot;                 &quot;date_index&quot;                    </span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a><span class="co">#&gt; [73] &quot;replantedTF&quot;                    &quot;num_components&quot;</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
